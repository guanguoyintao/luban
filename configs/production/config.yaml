# 推荐系统配置文件 - 生产环境

# 服务器配置
server:
  host: 0.0.0.0
  port: 8080
  timeout: 60
  read_timeout: 60
  write_timeout: 60
  idle_timeout: 120
  max_header_bytes: 1048576

# 日志配置
logging:
  level: warn
  format: json
  output: file
  file:
    path: /var/log/recommendation/recommendation.log
    max_size: 1000
    max_backups: 30
    max_age: 90
    compress: true

# Redis配置
redis:
  host: redis-cluster.internal
  port: 6379
  password: "${REDIS_PASSWORD}"
  database: 0
  pool_size: 100
  max_retries: 5
  dial_timeout: 10
  read_timeout: 5
  write_timeout: 5
  idle_timeout: 300
  max_active_conns: 1000
  max_idle_conns: 500

# MySQL配置
mysql:
  host: mysql-cluster.internal
  port: 3306
  database: recommendation_system
  username: "${MYSQL_USER}"
  password: "${MYSQL_PASSWORD}"
  charset: utf8mb4
  collation: utf8mb4_unicode_ci
  max_connections: 500
  max_idle_connections: 250
  max_lifetime: 3600
  log_level: warn
  slow_threshold: 100

# MongoDB配置
mongodb:
  uri: "mongodb://mongodb-cluster.internal:27017"
  database: recommendation_system
  timeout: 30
  pool_size: 50
  max_retries: 5

# Elasticsearch配置
elasticsearch:
  addresses:
    - http://elasticsearch-cluster.internal:9200
  username: "${ES_USERNAME}"
  password: "${ES_PASSWORD}"
  index_prefix: recommendation
  timeout: 30
  max_retries: 5

# Kafka配置
kafka:
  brokers:
    - kafka-cluster.internal:9092
  client_id: recommendation-system
  version: 2.6.0
  timeout: 30
  max_retries: 5

# 推荐算法配置
algorithms:
  enabled:
    - collaborative_filtering
    - content_based_filtering
    - hybrid_filtering
    - deep_learning
    - popularity
  
  collaborative_filtering:
    name: "协同过滤算法"
    weight: 0.3
    enabled: true
    parameters:
      neighbors: 100
      similarity_threshold: 0.2
      min_common_items: 5
      max_recommendations: 200
      normalization_method: "mean_centering"
    
  content_based_filtering:
    name: "基于内容过滤算法"
    weight: 0.3
    enabled: true
    parameters:
      feature_weights:
        category: 0.4
        tags: 0.3
        price: 0.2
        brand: 0.1
      similarity_threshold: 0.4
      learning_rate: 0.01
      decay_factor: 0.95
      max_features: 200
    
  hybrid_filtering:
    name: "混合过滤算法"
    weight: 0.2
    enabled: true
    parameters:
      collaborative_weight: 0.4
      content_based_weight: 0.4
      diversity_weight: 0.1
      popularity_weight: 0.05
      recency_weight: 0.05
      enable_diversity: true
      enable_popularity: true
      enable_recency: true
    
  deep_learning:
    name: "深度学习算法"
    weight: 0.1
    enabled: true
    parameters:
      model_path: /models/deep_learning
      batch_size: 128
      embedding_dim: 64
      hidden_layers: [256, 128, 64]
      dropout_rate: 0.2
      learning_rate: 0.001
      epochs: 100
    
  popularity:
    name: "流行度算法"
    weight: 0.1
    enabled: true
    parameters:
      time_window: "30d"
      min_interactions: 100
      decay_factor: 0.95
      category_boost: 1.5

# 推荐策略配置
strategies:
  personalized:
    enabled: true
    weight: 0.7
    priority: 1
    description: "个性化推荐策略"
    
  popular:
    enabled: true
    weight: 0.15
    priority: 2
    description: "热门推荐策略"
    scenarios:
      - home_page
      - search_result
    
  similarity:
    enabled: true
    weight: 0.15
    priority: 3
    description: "相似性推荐策略"
    scenarios:
      - product_detail

# 数据源配置
datasources:
  redis:
    primary:
      enabled: true
      type: redis
      config:
        host: redis-cluster.internal
        port: 6379
        database: 0
        pool_size: 100
        
    cache:
      enabled: true
      type: redis
      config:
        host: redis-cache-cluster.internal
        port: 6379
        database: 1
        pool_size: 200
        
  mysql:
    primary:
      enabled: true
      type: mysql
      config:
        host: mysql-primary.internal
        port: 3306
        database: recommendation_system
        username: "${MYSQL_USER}"
        password: "${MYSQL_PASSWORD}"
        max_connections: 500
        
    read_replica:
      enabled: true
      type: mysql
      config:
        host: mysql-replica.internal
        port: 3306
        database: recommendation_system
        username: "${MYSQL_READ_USER}"
        password: "${MYSQL_READ_PASSWORD}"
        max_connections: 1000
        
  mongodb:
    primary:
      enabled: true
      type: mongodb
      config:
        uri: "mongodb://mongodb-cluster.internal:27017"
        database: recommendation_system
        pool_size: 50
        
  elasticsearch:
    primary:
      enabled: true
      type: elasticsearch
      config:
        addresses:
          - http://elasticsearch-cluster.internal:9200
        username: "${ES_USERNAME}"
        password: "${ES_PASSWORD}"
        index_prefix: recommendation

# 插件配置
plugins:
  enabled: true
  directory: /opt/recommendation/plugins
  auto_load: true
  load_order:
    - collaborative_filtering_v1
    - content_based_v1
    - deep_learning_v1
    - redis_datasource_v1
    - mysql_datasource_v1
    - mongodb_datasource_v1
    - elasticsearch_datasource_v1
    - logging_middleware_v1
    - rate_limit_middleware_v1
    - auth_middleware_v1
  
  configurations:
    collaborative_filtering_v1:
      neighbors: 100
      similarity_threshold: 0.2
      
    content_based_v1:
      feature_weights:
        category: 0.4
        tags: 0.3
        price: 0.2
        brand: 0.1
        
    deep_learning_v1:
      model_path: /models/deep_learning
      batch_size: 128
      embedding_dim: 64
      
    redis_datasource_v1:
      host: redis-cluster.internal
      port: 6379
      database: 0
      pool_size: 100
      
    mysql_datasource_v1:
      host: mysql-primary.internal
      port: 3306
      database: recommendation_system
      username: "${MYSQL_USER}"
      password: "${MYSQL_PASSWORD}"
      max_connections: 500
      
    mongodb_datasource_v1:
      uri: "mongodb://mongodb-cluster.internal:27017"
      database: recommendation_system
      pool_size: 50
      
    elasticsearch_datasource_v1:
      addresses:
        - http://elasticsearch-cluster.internal:9200
      username: "${ES_USERNAME}"
      password: "${ES_PASSWORD}"
      index_prefix: recommendation
      
    logging_middleware_v1:
      level: warn
      format: json
      output: file
      file_path: /var/log/recommendation/middleware.log
      
    rate_limit_middleware_v1:
      requests_per_minute: 600
      burst_size: 100
      key_prefix: rate_limit
      
    auth_middleware_v1:
      jwt_secret: "${JWT_SECRET}"
      token_expiry: 3600
      refresh_token_expiry: 86400

# 监控配置
monitoring:
  prometheus:
    enabled: true
    port: 9090
    path: /metrics
    namespace: recommendation_system
    
  jaeger:
    enabled: true
    endpoint: http://jaeger-collector.internal:14268/api/traces
    service_name: recommendation-system
    sample_rate: 0.01
    
  health_check:
    enabled: true
    path: /health
    timeout: 10
    checks:
      - redis
      - mysql
      - mongodb
      - elasticsearch
      - plugins

# 性能配置
performance:
  cache:
    enabled: true
    ttl: 1800
    max_entries: 100000
    
  connection_pool:
    max_idle: 500
    max_active: 1000
    idle_timeout: 300
    
  rate_limiting:
    enabled: true
    requests_per_minute: 600
    burst_size: 100
    
  circuit_breaker:
    enabled: true
    failure_threshold: 10
    success_threshold: 5
    timeout: 60

# 安全配置
security:
  auth:
    enabled: true
    jwt_secret: "${JWT_SECRET}"
    token_expiry: 3600
    refresh_token_expiry: 86400
    
  encryption:
    enabled: true
    algorithm: AES-256-GCM
    key: "${ENCRYPTION_KEY}"
    
  cors:
    enabled: true
    allowed_origins:
      - "https://*.example.com"
      - "https://example.com"
    allowed_methods:
      - GET
      - POST
      - PUT
      - DELETE
    allowed_headers:
      - Authorization
      - Content-Type
      - X-Requested-With
    
  rate_limiting:
    enabled: true
    requests_per_minute: 600
    burst_size: 100
    
  tls:
    enabled: true
    cert_file: /etc/ssl/certs/recommendation.crt
    key_file: /etc/ssl/private/recommendation.key
    min_version: 1.2

# 备份配置
backup:
  enabled: true
  schedule: "0 2 * * *"  # 每天凌晨2点
  retention_days: 30
  
  mysql:
    enabled: true
    databases:
      - recommendation_system
    
  redis:
    enabled: true
    databases:
      - 0
      - 1
    
  elasticsearch:
    enabled: true
    indices:
      - recommendation_*

# 告警配置
alerts:
  enabled: true
  channels:
    - type: email
      enabled: true
      config:
        smtp_host: smtp.internal
        smtp_port: 587
        username: "${ALERT_EMAIL_USER}"
        password: "${ALERT_EMAIL_PASSWORD}"
        from: alerts@example.com
        to:
          - ops@example.com
          - dev@example.com
    
    - type: slack
      enabled: true
      config:
        webhook_url: "${SLACK_WEBHOOK_URL}"
        channel: "#alerts"
        username: "Recommendation Bot"
    
    - type: pagerduty
      enabled: true
      config:
        integration_key: "${PAGERDUTY_INTEGRATION_KEY}"
        service_key: "${PAGERDUTY_SERVICE_KEY}"

# 规则配置
rules:
  system_health:
    - name: "CPU使用率过高"
      condition: "cpu_usage > 80"
      severity: warning
      duration: 5m
      
    - name: "内存使用率过高"
      condition: "memory_usage > 85"
      severity: warning
      duration: 5m
      
    - name: "磁盘使用率过高"
      condition: "disk_usage > 90"
      severity: critical
      duration: 1m
      
    - name: "服务不可用"
      condition: "service_up == 0"
      severity: critical
      duration: 30s
      
  recommendation_performance:
    - name: "推荐响应时间过长"
      condition: "recommendation_response_time > 500ms"
      severity: warning
      duration: 5m
      
    - name: "推荐准确率过低"
      condition: "recommendation_accuracy < 0.5"
      severity: warning
      duration: 10m
      
    - name: "推荐点击率过低"
      condition: "recommendation_ctr < 0.02"
      severity: warning
      duration: 15m